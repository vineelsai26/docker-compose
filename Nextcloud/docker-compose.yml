version: '3'

services:
  nextcloud:
    container_name: nextcloud
    image: nextcloud:28.0.0-fpm-alpine
    restart: always
    user: "1000:1000"
    volumes:
      - ./html:/var/www/html
    env_file:
      - .env
  server:
    container_name: nextcloud_nginx
    image: nginx
    restart: always
    ports:
      - 8080:80
    links:
      - nextcloud
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
    volumes_from:
      - nextcloud
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.entrypoints=http"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.home.vineelsai.com`)||Host(`nextcloud.vineelsai.com`)"
      - "traefik.http.middlewares.nextcloud-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-https-redirect"
      - "traefik.http.routers.nextcloud-secure.entrypoints=https"
      - "traefik.http.routers.nextcloud-secure.rule=Host(`nextcloud.home.vineelsai.com`)||Host(`nextcloud.vineelsai.com`)"
      - "traefik.http.routers.nextcloud-secure.tls=true"
      - "traefik.http.routers.nextcloud-secure.service=nextcloud"
      - "traefik.http.middlewares.nextcloud-https-redirect.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-https-redirect.redirectregex.regex='https://(.*)/.well-known/(?:card|cal)dav'"
      - "traefik.http.middlewares.nextcloud-https-redirect.redirectregex.replacement='https://$${1}/remote.php/dav'"
      - "traefik.http.middlewares.nextcloud-https-redirect.headers.stsSeconds=15552000"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

networks:
  default:
    name: traefik_proxy
    external: true
